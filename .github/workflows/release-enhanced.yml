name: Release Enhanced

on:
  push:
    tags:
      - 'v*'

env:
  GO_VERSION: '1.22'

jobs:
  # Phase 1: Code Format & Quality Check
  quality-check:
    name: Code Format & Quality Check
    runs-on: ubuntu-latest
    outputs:
      quality-passed: ${{ steps.quality-gate.outputs.passed }}
      error-message: ${{ steps.quality-gate.outputs.error-message }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Download dependencies
        run: make deps

      # 1. Code Format Check
      - name: Code Format Check
        id: fmt-check
        run: |
          echo "üîç Checking code formatting..."
          UNFORMATTED=$(gofmt -s -l .)
          if [ -n "$UNFORMATTED" ]; then
            echo "‚ùå Code formatting issues found:"
            echo "$UNFORMATTED"
            echo ""
            echo "üîß To fix: run 'gofmt -s -w .' locally"
            echo ""
            echo "‚è∏Ô∏è Workflow paused - please fix formatting issues before proceeding"
            echo "error-message=Code formatting issues found. Run 'gofmt -s -w .' to fix." >> $GITHUB_OUTPUT
            exit 1
          fi
          echo "‚úÖ Code formatting check passed"

      # 2. Code Quality Check
      - name: Code Quality Check
        id: quality-check
        run: |
          echo "üîç Running code quality checks..."
          
          # Run go vet
          echo "Running go vet..."
          if ! go vet ./...; then
            echo "‚ùå go vet found issues"
            echo "üîß Please fix vet issues locally with: go vet ./..."
            echo ""
            echo "‚è∏Ô∏è Workflow paused - please fix vet issues before proceeding"
            echo "error-message=go vet found issues. Run 'go vet ./...' to fix." >> $GITHUB_OUTPUT
            exit 1
          fi
          
          # Install and run golangci-lint
          echo "Installing golangci-lint..."
          go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest
          
          echo "Running golangci-lint..."
          if ! golangci-lint run; then
            echo "‚ùå golangci-lint found issues"
            echo "üîß Please fix linting issues locally with: golangci-lint run"
            echo ""
            echo "‚è∏Ô∏è Workflow paused - please fix linting issues before proceeding"
            echo "error-message=golangci-lint found issues. Run 'golangci-lint run' to fix." >> $GITHUB_OUTPUT
            exit 1
          fi
          
          echo "‚úÖ Code quality checks passed"

      # Quality Gate
      - name: Quality Gate
        id: quality-gate
        run: |
          echo "passed=true" >> $GITHUB_OUTPUT
          echo "‚úÖ All quality checks passed - proceeding to code review"

  # Phase 2: Code Review Check
  code-review:
    name: Code Review Check
    runs-on: ubuntu-latest
    needs: quality-check
    if: needs.quality-check.outputs.quality-passed == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Code Review Analysis
        run: |
          echo "üîç Running automated code review..."
          
          # Check for breaking changes
          echo "Analyzing changes since last tag..."
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          if [ -n "$PREV_TAG" ]; then
            CHANGED_FILES=$(git diff --name-only $PREV_TAG..HEAD | grep -E "\.go$" || true)
            if [ -n "$CHANGED_FILES" ]; then
              echo "üìù Changed Go files:"
              echo "$CHANGED_FILES"
              
              # Check for breaking changes in core packages
              if echo "$CHANGED_FILES" | grep -E "(internal|cmd)/"; then
                echo "‚ö†Ô∏è Core code changes detected - manual review recommended"
              fi
            fi
          fi
          
          # Check for TODO/FIXME comments
          TODO_COUNT=$(grep -r "TODO\|FIXME" --include="*.go" . | wc -l)
          if [ "$TODO_COUNT" -gt 0 ]; then
            echo "‚ö†Ô∏è Found $TODO_COUNT TODO/FIXME comments that should be addressed"
          fi
          
          # Check for function documentation
          UNDOC_FUNCS=$(grep -r "^func [A-Z]" --include="*.go" . | grep -v "//" | wc -l)
          if [ "$UNDOC_FUNCS" -gt 0 ]; then
            echo "‚ö†Ô∏è Found $UNDOC_FUNCS undocumented public functions"
          fi
          
          # Check for hardcoded credentials
          if grep -r "password\|secret\|key" --include="*.go" . | grep -v "_test.go" | grep -v "//.*password\|//.*secret\|//.*key" > /dev/null; then
            echo "‚ö†Ô∏è Potential hardcoded credentials found - please review"
          fi
          
          echo "‚úÖ Code review analysis completed"

  # Phase 3: Test Suite
  test:
    name: Test Suite
    runs-on: ubuntu-latest
    needs: [quality-check, code-review]
    if: needs.quality-check.outputs.quality-passed == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Download dependencies
        run: make deps

      # 3. Run Test Cases
      - name: Run Test Cases
        id: test-run
        run: |
          echo "üß™ Running test suite..."
          
          # Run unit tests with coverage
          echo "Running unit tests with coverage..."
          if ! go test -v -race -coverprofile=coverage.out ./...; then
            echo "‚ùå Tests failed"
            echo "üîß Please fix failing tests locally with: go test ./..."
            exit 1
          fi
          
          # Check coverage
          COVERAGE=$(go tool cover -func=coverage.out | grep total | awk '{print $3}' | sed 's/%//')
          echo "üìä Test coverage: ${COVERAGE}%"
          
          if (( $(echo "$COVERAGE < 70" | bc -l) )); then
            echo "‚ö†Ô∏è Test coverage is below 70% (${COVERAGE}%)"
            echo "üí° Consider adding more tests to improve coverage"
          else
            echo "‚úÖ Test coverage is acceptable (${COVERAGE}%)"
          fi
          
          echo "‚úÖ All tests passed"

      - name: Upload Coverage
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.out
          flags: unittests
          name: codecov-umbrella
        continue-on-error: true

  # Phase 4: Build
  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [quality-check, code-review, test]
    if: needs.quality-check.outputs.quality-passed == 'true'
    strategy:
      matrix:
        include:
          - goos: windows
            goarch: amd64
            output: sentinelgo-windows-amd64.exe
          - goos: linux
            goarch: amd64
            output: sentinelgo-linux-amd64
          - goos: linux
            goarch: arm64
            output: sentinelgo-linux-arm64
          - goos: darwin
            goarch: amd64
            output: sentinelgo-darwin-amd64
          - goos: darwin
            goarch: arm64
            output: sentinelgo-darwin-arm64

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Get version
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Build
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          VERSION: ${{ steps.version.outputs.VERSION }}
        run: |
          echo "üèóÔ∏è Building for ${{ matrix.goos }}/${{ matrix.goarch }}..."
          CGO_ENABLED=0 go build -ldflags "-X sentinelgo/cmd/sentinelgo.Version=$VERSION -X sentinelgo/internal/config.Version=$VERSION" -o ${{ matrix.output }} ./cmd/sentinelgo

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.output }}
          path: ${{ matrix.output }}

  # Phase 5: Create Release
  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [quality-check, code-review, test, build]
    if: needs.quality-check.outputs.quality-passed == 'true'
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Download artifacts
        uses: actions/download-artifact@v3
        with:
          path: artifacts

      - name: Create release packages
        run: |
          mkdir -p release
          cp install.sh INSTALLATION.md release/
          
          cd release
          tar -czf "sentinelgo-${{ steps.version.outputs.VERSION }}-windows.tar.gz" "../artifacts/sentinelgo-windows-amd64.exe" install.sh INSTALLATION.md
          tar -czf "sentinelgo-${{ steps.version.outputs.VERSION }}-linux-amd64.tar.gz" "../artifacts/sentinelgo-linux-amd64" install.sh INSTALLATION.md
          tar -czf "sentinelgo-${{ steps.version.outputs.VERSION }}-linux-arm64.tar.gz" "../artifacts/sentinelgo-linux-arm64" install.sh INSTALLATION.md
          tar -czf "sentinelgo-${{ steps.version.outputs.VERSION }}-darwin-amd64.tar.gz" "../artifacts/sentinelgo-darwin-amd64" install.sh INSTALLATION.md
          tar -czf "sentinelgo-${{ steps.version.outputs.VERSION }}-darwin-arm64.tar.gz" "../artifacts/sentinelgo-darwin-arm64" install.sh INSTALLATION.md

      - name: Generate Release Notes
        id: release_notes
        run: |
          cat > release_notes.md << 'EOF'
          # üöÄ SentinelGo ${{ steps.version.outputs.VERSION }}
          
          ## ‚úÖ Quality Checks Passed
          - ‚úÖ Code formatting verified
          - ‚úÖ Code quality checks passed  
          - ‚úÖ Code review completed
          - ‚úÖ Test suite executed
          - ‚úÖ Cross-platform build successful
          
          ## üìã Changes
          EOF
          
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          if [ -n "$PREVIOUS_TAG" ]; then
            git log --pretty=format:"- %s" $PREVIOUS_TAG..HEAD >> release_notes.md
          else
            echo "- Initial release" >> release_notes.md
          fi
          
          cat >> release_notes.md << 'EOF'
          
          ## üõ†Ô∏è Installation
          1. Download package for your OS/architecture
          2. Extract archive  
          3. Run: `sudo ./install.sh`
          4. Enable auto-updates: `sudo ./sentinelgo -enable-auto-update`
          EOF
          
          NOTES=$(cat release_notes.md | sed 's/"/\\"/g' | tr '\n' '\\n')
          echo "notes=$NOTES" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.VERSION }}
          name: SentinelGo ${{ steps.version.outputs.VERSION }}
          body: ${{ steps.release_notes.outputs.notes }}
          files: |
            release/sentinelgo-${{ steps.version.outputs.VERSION }}-windows.tar.gz
            release/sentinelgo-${{ steps.version.outputs.VERSION }}-linux-amd64.tar.gz
            release/sentinelgo-${{ steps.version.outputs.VERSION }}-linux-arm64.tar.gz
            release/sentinelgo-${{ steps.version.outputs.VERSION }}-darwin-amd64.tar.gz
            release/sentinelgo-${{ steps.version.outputs.VERSION }}-darwin-arm64.tar.gz
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Quality Check Failed Notification
  quality-failed:
    name: Quality Check Failed
    runs-on: ubuntu-latest
    needs: quality-check
    if: needs.quality-check.outputs.quality-passed != 'true'
    steps:
      - name: Quality Check Failed
        run: |
          echo "‚ùå Quality checks failed!"
          echo ""
          echo "üìã Error: ${{ needs.quality-check.outputs.error-message }}"
          echo ""
          echo "üîß Please fix the issues locally and push the fixed code."
          echo "üí° Run 'make pre-release' locally to check before pushing."
          echo ""
          echo "‚è∏Ô∏è Workflow stopped - no release will be created."
          exit 1
